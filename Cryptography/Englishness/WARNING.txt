WARNING: 

This section may contain serious spagetti code.
Proceed with caution.